<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIFTY/SENSEX Trading Dashboard - Complete App</title>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.18.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>

    <style>
        /* ... (keeping all previous styles from trading_app.html) ... */

        /* Additional styles for complete app */
        .sub-tabs {
            display: flex;
            gap: 5px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
        }

        .sub-tab {
            padding: 8px 16px;
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
            transition: all 0.3s ease;
        }

        .sub-tab:hover {
            background-color: var(--border-color);
            color: var(--text-primary);
        }

        .sub-tab.active {
            background-color: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        .signal-setup-card {
            background-color: var(--bg-card);
            border: 2px solid var(--accent-blue);
            border-radius: 8px;
            padding: 20px;
            margin: 10px 0;
        }

        .position-card {
            background-color: var(--bg-card);
            border-left: 4px solid var(--accent-green);
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .position-card.loss {
            border-left-color: var(--accent-red);
        }

        .indicator-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .indicator-card {
            background-color: var(--bg-card);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .sentiment-meter {
            width: 100%;
            height: 30px;
            background: linear-gradient(to right, #f44336 0%, #ff9800 50%, #4caf50 100%);
            border-radius: 15px;
            position: relative;
            margin: 15px 0;
        }

        .sentiment-pointer {
            position: absolute;
            width: 4px;
            height: 40px;
            background-color: white;
            top: -5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
        }

        .option-chain-table {
            width: 100%;
            font-size: 13px;
        }

        .option-chain-table th {
            background-color: var(--bg-card);
            padding: 10px;
            position: sticky;
            top: 0;
        }

        .option-chain-table td {
            padding: 8px;
            text-align: center;
        }

        .atm-row {
            background-color: rgba(33, 150, 243, 0.1);
            font-weight: bold;
        }

        .call-side {
            background-color: rgba(76, 175, 80, 0.05);
        }

        .put-side {
            background-color: rgba(244, 67, 54, 0.05);
        }

        .screener-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .trade-action-btn {
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .trade-action-btn.buy {
            background-color: var(--accent-green);
            color: white;
        }

        .trade-action-btn.sell {
            background-color: var(--accent-red);
            color: white;
        }

        .trade-action-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .level-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .level-support {
            background-color: rgba(76, 175, 80, 0.2);
            color: var(--accent-green);
        }

        .level-resistance {
            background-color: rgba(244, 67, 54, 0.2);
            color: var(--accent-red);
        }

        .vob-block {
            position: absolute;
            width: 100%;
            background-color: rgba(156, 39, 176, 0.2);
            border: 1px solid var(--accent-purple);
        }

        .market-regime-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 14px;
        }

        .regime-trending {
            background-color: rgba(33, 150, 243, 0.2);
            color: var(--accent-blue);
            border: 2px solid var(--accent-blue);
        }

        .regime-ranging {
            background-color: rgba(255, 152, 0, 0.2);
            color: var(--accent-yellow);
            border: 2px solid var(--accent-yellow);
        }

        .regime-volatile {
            background-color: rgba(244, 67, 54, 0.2);
            color: var(--accent-red);
            border: 2px solid var(--accent-red);
        }

        .signal-star {
            font-size: 24px;
            margin: 0 2px;
        }

        .signal-star.active {
            color: var(--accent-yellow);
        }

        .signal-star.inactive {
            color: var(--text-secondary);
        }

        .trade-log-entry {
            background-color: var(--bg-card);
            padding: 12px;
            margin: 8px 0;
            border-left: 4px solid var(--accent-blue);
            border-radius: 4px;
            font-size: 13px;
        }

        .pnl-positive {
            color: var(--accent-green);
            font-weight: bold;
        }

        .pnl-negative {
            color: var(--accent-red);
            font-weight: bold;
        }

        .volatility-gauge {
            width: 100%;
            height: 20px;
            background-color: var(--bg-card);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .volatility-fill {
            height: 100%;
            background: linear-gradient(to right, var(--accent-green), var(--accent-yellow), var(--accent-red));
            transition: width 0.5s ease;
        }

        .alert-box {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .alert-box.bullish {
            background-color: rgba(76, 175, 80, 0.1);
            border-left: 4px solid var(--accent-green);
        }

        .alert-box.bearish {
            background-color: rgba(244, 67, 54, 0.1);
            border-left: 4px solid var(--accent-red);
        }

        .alert-box.neutral {
            background-color: rgba(255, 152, 0, 0.1);
            border-left: 4px solid var(--accent-yellow);
        }

        .market-depth-row {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 10px;
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .bid-side {
            text-align: right;
            color: var(--accent-green);
        }

        .ask-side {
            text-align: left;
            color: var(--accent-red);
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .indicator-grid {
                grid-template-columns: 1fr;
            }

            .market-depth-row {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <h1>üéØ NIFTY Trader Pro</h1>

            <div class="sidebar-section">
                <h3>Connection Status</h3>
                <div class="status-indicator">
                    <div class="status-dot status-disconnected" id="connectionDot"></div>
                    <span id="connectionText">Disconnected</span>
                </div>
            </div>

            <div class="sidebar-section">
                <h3>DhanHQ API Configuration</h3>
                <input type="password" class="config-input" id="accessToken" placeholder="Access Token">
                <input type="text" class="config-input" id="clientId" placeholder="Client ID">
                <button class="btn btn-primary" id="connectBtn">Connect WebSocket</button>
                <button class="btn btn-danger" id="disconnectBtn" disabled>Disconnect</button>
            </div>

            <div class="sidebar-section">
                <h3>Auto Refresh Settings</h3>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span>Auto-refresh</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="autoRefreshToggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <input type="number" class="config-input" id="refreshInterval" placeholder="Interval (seconds)" value="30" min="5" max="300">
            </div>

            <div class="sidebar-section">
                <h3>Market Selection</h3>
                <select class="config-input" id="marketSelect">
                    <option value="NIFTY">NIFTY 50</option>
                    <option value="SENSEX">SENSEX</option>
                    <option value="BANKNIFTY">BANK NIFTY</option>
                    <option value="FINNIFTY">FIN NIFTY</option>
                </select>
            </div>

            <div class="sidebar-section">
                <h3>Telegram Alerts</h3>
                <input type="text" class="config-input" id="telegramToken" placeholder="Bot Token">
                <input type="text" class="config-input" id="telegramChatId" placeholder="Chat ID">
                <button class="btn btn-success" id="testTelegramBtn">Test Alert</button>
            </div>

            <div class="sidebar-section">
                <h3>Quick Actions</h3>
                <button class="btn btn-success" id="fetchDataBtn">Fetch Latest Data</button>
                <button class="btn btn-primary" id="refreshChartsBtn">Refresh Charts</button>
                <button class="btn btn-primary" id="clearLogsBtn">Clear Logs</button>
            </div>

            <div class="sidebar-section">
                <h3>Trading Parameters</h3>
                <label style="font-size: 12px; color: var(--text-secondary);">VOB Proximity (points)</label>
                <input type="number" class="config-input" id="vobProximity" value="8" min="1" max="50">

                <label style="font-size: 12px; color: var(--text-secondary); margin-top: 10px;">Risk per Trade (%)</label>
                <input type="number" class="config-input" id="riskPercent" value="2" min="0.5" max="10" step="0.5">
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div>
                    <h1 class="page-title">NIFTY/SENSEX Trading Dashboard</h1>
                    <p style="color: var(--text-secondary); margin-top: 5px;">Real-time Market Analysis & Trade Execution Platform</p>
                </div>
                <div class="market-status">
                    <div class="market-badge" id="marketStatusBadge">Market Closed</div>
                    <span id="currentTime">--:--:-- IST</span>
                </div>
            </header>

            <!-- Quick Market Overview -->
            <div class="card-grid">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">NIFTY 50</span>
                        <span>üìà</span>
                    </div>
                    <div class="card-value value-neutral" id="niftyPrice">--</div>
                    <div class="card-subtitle">
                        <span id="niftyChange">-- (--)</span> |
                        <span id="niftyATM">ATM: --</span>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">SENSEX</span>
                        <span>üìä</span>
                    </div>
                    <div class="card-value value-neutral" id="sensexPrice">--</div>
                    <div class="card-subtitle">
                        <span id="sensexChange">-- (--)</span> |
                        <span id="sensexATM">ATM: --</span>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">India VIX</span>
                        <span>‚ö°</span>
                    </div>
                    <div class="card-value value-neutral" id="vixPrice">--</div>
                    <div class="card-subtitle">
                        <span id="vixChange">--</span> | Fear Index
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Market Sentiment</span>
                        <span>üéØ</span>
                    </div>
                    <div class="card-value value-neutral" id="overallSentiment">NEUTRAL</div>
                    <div class="card-subtitle">
                        <span id="sentimentScore">Score: 0</span>
                    </div>
                </div>
            </div>

            <!-- Main Tabs -->
            <div class="tabs-container">
                <div class="tabs">
                    <button class="tab active" data-tab="sentiment">üåü Market Sentiment</button>
                    <button class="tab" data-tab="setup">üéØ Trade Setup</button>
                    <button class="tab" data-tab="signals">üìä Active Signals</button>
                    <button class="tab" data-tab="positions">üìà Positions</button>
                    <button class="tab" data-tab="bias">üé≤ Bias Analysis</button>
                    <button class="tab" data-tab="charts">üìâ Chart Analysis</button>
                    <button class="tab" data-tab="options">‚ö° Options Screener</button>
                    <button class="tab" data-tab="enhanced">üåê Enhanced Data</button>
                    <button class="tab" data-tab="screener">üîç Stock Screener</button>
                </div>
            </div>

            <!-- TAB 1: MARKET SENTIMENT -->
            <div class="tab-content active" id="sentiment">
                <h2>üåü Overall Market Sentiment</h2>

                <!-- Sentiment Meter -->
                <div class="card">
                    <h3>Market Sentiment Gauge</h3>
                    <div class="sentiment-meter">
                        <div class="sentiment-pointer" id="sentimentPointer" style="left: 50%;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                        <span style="color: var(--accent-red);">Bearish</span>
                        <span style="color: var(--text-secondary);">Neutral</span>
                        <span style="color: var(--accent-green);">Bullish</span>
                    </div>
                </div>

                <!-- Market Regime -->
                <div class="card">
                    <div class="card-header">
                        <h3>Market Regime Detection</h3>
                        <span class="market-regime-badge regime-trending" id="marketRegimeBadge">TRENDING</span>
                    </div>
                    <div id="regimeDescription" style="margin-top: 10px; color: var(--text-secondary);">
                        Market is in a strong trending phase. Follow the trend for higher probability trades.
                    </div>
                </div>

                <!-- Component Sentiment Scores -->
                <h3 style="margin-top: 30px;">Component Analysis</h3>
                <div class="indicator-grid">
                    <div class="indicator-card">
                        <h4>HTF S/R Signal</h4>
                        <div class="card-value value-neutral" id="htfSentiment">0</div>
                        <div class="card-subtitle">Higher Timeframe Support/Resistance</div>
                    </div>

                    <div class="indicator-card">
                        <h4>VOB Signal</h4>
                        <div class="card-value value-neutral" id="vobSentiment">0</div>
                        <div class="card-subtitle">Volume Order Blocks</div>
                    </div>

                    <div class="indicator-card">
                        <h4>Option Chain Bias</h4>
                        <div class="card-value value-neutral" id="optionBias">0</div>
                        <div class="card-subtitle">PCR & OI Analysis</div>
                    </div>

                    <div class="indicator-card">
                        <h4>Technical Score</h4>
                        <div class="card-value value-neutral" id="technicalScore">0</div>
                        <div class="card-subtitle">RSI, MACD, SuperTrend</div>
                    </div>

                    <div class="indicator-card">
                        <h4>Volume Profile</h4>
                        <div class="card-value value-neutral" id="volumeProfile">0</div>
                        <div class="card-subtitle">Volume Analysis</div>
                    </div>

                    <div class="indicator-card">
                        <h4>Proximity Alerts</h4>
                        <div class="card-value value-neutral" id="proximityAlerts">0</div>
                        <div class="card-subtitle">Near Key Levels</div>
                    </div>
                </div>

                <!-- Current Alerts -->
                <h3 style="margin-top: 30px;">Active Market Alerts</h3>
                <div id="marketAlerts">
                    <div class="info-box info">
                        <span>‚ÑπÔ∏è</span>
                        <div>Connect to receive real-time market alerts and signals</div>
                    </div>
                </div>
            </div>

            <!-- TAB 2: TRADE SETUP -->
            <div class="tab-content" id="setup">
                <h2>üéØ Trade Setup - VOB Based Manual Entry</h2>

                <div class="card">
                    <h3>Current Market Position</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-label">Nearest Support</div>
                            <div class="stat-value level-support" id="nearestSupport">--</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Current Price</div>
                            <div class="stat-value" id="currentPrice">--</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Nearest Resistance</div>
                            <div class="stat-value level-resistance" id="nearestResistance">--</div>
                        </div>
                    </div>
                </div>

                <div class="signal-setup-card">
                    <h3>Create New Signal Setup</h3>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                        <div>
                            <label>Select Index:</label>
                            <select class="config-input" id="setupIndex">
                                <option value="NIFTY">NIFTY 50</option>
                                <option value="SENSEX">SENSEX</option>
                                <option value="BANKNIFTY">BANK NIFTY</option>
                            </select>
                        </div>

                        <div>
                            <label>Direction:</label>
                            <select class="config-input" id="setupDirection">
                                <option value="CALL">CALL (Bullish)</option>
                                <option value="PUT">PUT (Bearish)</option>
                            </select>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                        <div>
                            <label>VOB Support Level:</label>
                            <input type="number" class="config-input" id="vobSupport" placeholder="e.g., 24000">
                        </div>

                        <div>
                            <label>VOB Resistance Level:</label>
                            <input type="number" class="config-input" id="vobResistance" placeholder="e.g., 24200">
                        </div>
                    </div>

                    <button class="btn btn-primary" id="createSetupBtn" style="width: 100%; padding: 15px;">
                        ‚úÖ Create Signal Setup
                    </button>
                </div>

                <div id="setupInstructions" class="info-box info">
                    <span>üìñ</span>
                    <div>
                        <strong>How to create a setup:</strong><br>
                        1. Select your index (NIFTY/SENSEX)<br>
                        2. Choose direction based on market bias<br>
                        3. Enter VOB Support and Resistance levels from chart<br>
                        4. Click Create Signal Setup<br>
                        5. Wait for 3 confirmations before executing trade
                    </div>
                </div>
            </div>

            <!-- TAB 3: ACTIVE SIGNALS -->
            <div class="tab-content" id="signals">
                <h2>üìä Active Signal Setups</h2>

                <div id="activeSignalsList">
                    <div class="info-box info">
                        <span>‚ÑπÔ∏è</span>
                        <div>No active signal setups. Create one in the Trade Setup tab.</div>
                    </div>
                </div>
            </div>

            <!-- TAB 4: POSITIONS -->
            <div class="tab-content" id="positions">
                <h2>üìà Active Positions & Trade Monitoring</h2>

                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Total Positions</div>
                        <div class="stat-value" id="totalPositions">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Today's PnL</div>
                        <div class="stat-value pnl-positive" id="todayPnL">‚Çπ0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Win Rate</div>
                        <div class="stat-value" id="winRate">0%</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Avg R:R</div>
                        <div class="stat-value" id="avgRR">0:0</div>
                    </div>
                </div>

                <h3 style="margin-top: 30px;">Open Positions</h3>
                <div id="openPositionsList">
                    <div class="info-box info">
                        <span>‚ÑπÔ∏è</span>
                        <div>No open positions. Execute a trade from Active Signals tab.</div>
                    </div>
                </div>

                <h3 style="margin-top: 30px;">Today's Trade Log</h3>
                <div id="tradeLogList">
                    <div class="info-box info">
                        <span>üìù</span>
                        <div>No trades executed today.</div>
                    </div>
                </div>
            </div>

            <!-- TAB 5: BIAS ANALYSIS -->
            <div class="tab-content" id="bias">
                <h2>üé≤ Bias Analysis Pro</h2>

                <div class="sub-tabs">
                    <button class="sub-tab active" data-subtab="bias-overview">Overview</button>
                    <button class="sub-tab" data-subtab="bias-levels">Support/Resistance</button>
                    <button class="sub-tab" data-subtab="bias-indicators">Indicators</button>
                    <button class="sub-tab" data-subtab="bias-vob">VOB Analysis</button>
                    <button class="sub-tab" data-subtab="bias-htf">HTF Analysis</button>
                </div>

                <div class="sub-tab-content active" id="bias-overview">
                    <div class="card">
                        <h3>Current Bias Summary</h3>
                        <div class="card-value value-neutral" id="currentBias">NEUTRAL</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="biasProgress" style="width: 50%"></div>
                        </div>
                        <div style="margin-top: 15px;">
                            <strong>Overall Score:</strong> <span id="biasOverallScore">0</span><br>
                            <strong>Confidence:</strong> <span id="biasConfidence">--</span><br>
                            <strong>Recommendation:</strong> <span id="biasRecommendation">--</span>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3>Price Action with Bias Levels</h3>
                        <div class="chart-wrapper" style="height: 500px;">
                            <div id="biasChart"></div>
                        </div>
                    </div>
                </div>

                <!-- Other bias subtabs would go here -->
                <div class="sub-tab-content" id="bias-levels">
                    <h3>Support & Resistance Levels</h3>
                    <div class="data-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Level</th>
                                    <th>Strength</th>
                                    <th>Distance</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="levelsTableBody">
                                <tr><td colspan="5" style="text-align: center; padding: 20px;">Loading levels...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- TAB 6: CHART ANALYSIS -->
            <div class="tab-content" id="charts">
                <h2>üìâ Advanced Chart Analysis</h2>

                <div class="sub-tabs">
                    <button class="sub-tab active" data-subtab="chart-candlestick">Candlestick</button>
                    <button class="sub-tab" data-subtab="chart-indicators">Technical Indicators</button>
                    <button class="sub-tab" data-subtab="chart-patterns">Pattern Detection</button>
                    <button class="sub-tab" data-subtab="chart-volume">Volume Analysis</button>
                </div>

                <div class="sub-tab-content active" id="chart-candlestick">
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                        <select class="config-input" style="width: auto;" id="chartTimeframe">
                            <option value="1m">1 Minute</option>
                            <option value="5m" selected>5 Minutes</option>
                            <option value="15m">15 Minutes</option>
                            <option value="30m">30 Minutes</option>
                            <option value="1h">1 Hour</option>
                            <option value="1d">1 Day</option>
                        </select>

                        <button class="btn btn-primary" id="addSuperTrendBtn">Add SuperTrend</button>
                        <button class="btn btn-primary" id="addEMABtn">Add EMA</button>
                        <button class="btn btn-primary" id="addVWAPBtn">Add VWAP</button>
                    </div>

                    <div class="chart-container">
                        <div class="chart-wrapper" style="height: 600px;">
                            <div id="mainCandlestickChart"></div>
                        </div>
                    </div>
                </div>

                <div class="sub-tab-content" id="chart-indicators">
                    <div class="indicator-grid">
                        <div class="card">
                            <h4>RSI (14)</h4>
                            <div class="card-value value-neutral" id="chartRSI">--</div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="chartRSIProgress" style="width: 0%"></div>
                            </div>
                            <div class="card-subtitle" id="chartRSISignal">--</div>
                        </div>

                        <div class="card">
                            <h4>MACD</h4>
                            <div class="card-value value-neutral" id="chartMACD">--</div>
                            <div class="card-subtitle" id="chartMACDSignal">--</div>
                        </div>

                        <div class="card">
                            <h4>ATR (14)</h4>
                            <div class="card-value value-neutral" id="chartATR">--</div>
                            <div class="card-subtitle">Volatility Measure</div>
                        </div>

                        <div class="card">
                            <h4>Stochastic</h4>
                            <div class="card-value value-neutral" id="chartStoch">--</div>
                            <div class="card-subtitle" id="chartStochSignal">--</div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3>Indicator Chart</h3>
                        <div class="chart-wrapper">
                            <canvas id="indicatorChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 7: OPTIONS SCREENER -->
            <div class="tab-content" id="options">
                <h2>‚ö° NIFTY Option Screener v7.0</h2>

                <div class="card-grid">
                    <div class="card">
                        <h4>ATM Strike</h4>
                        <div class="card-value" id="optionATM">--</div>
                    </div>
                    <div class="card">
                        <h4>PCR Ratio</h4>
                        <div class="card-value" id="optionPCR">--</div>
                    </div>
                    <div class="card">
                        <h4>Max Pain</h4>
                        <div class="card-value" id="optionMaxPain">--</div>
                    </div>
                    <div class="card">
                        <h4>IV Percentile</h4>
                        <div class="card-value" id="optionIV">--</div>
                    </div>
                </div>

                <h3 style="margin-top: 20px;">Options Chain</h3>
                <div class="data-table" style="overflow-x: auto;">
                    <table class="option-chain-table">
                        <thead>
                            <tr>
                                <th colspan="5" class="call-side">CALLS</th>
                                <th>STRIKE</th>
                                <th colspan="5" class="put-side">PUTS</th>
                            </tr>
                            <tr>
                                <th class="call-side">OI</th>
                                <th class="call-side">Volume</th>
                                <th class="call-side">LTP</th>
                                <th class="call-side">IV</th>
                                <th class="call-side">Delta</th>
                                <th>PRICE</th>
                                <th class="put-side">Delta</th>
                                <th class="put-side">IV</th>
                                <th class="put-side">LTP</th>
                                <th class="put-side">Volume</th>
                                <th class="put-side">OI</th>
                            </tr>
                        </thead>
                        <tbody id="optionChainBody">
                            <tr><td colspan="11" style="text-align: center; padding: 40px;">Connect to load options chain data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TAB 8: ENHANCED MARKET DATA -->
            <div class="tab-content" id="enhanced">
                <h2>üåê Enhanced Market Data</h2>

                <h3>Global Markets</h3>
                <div class="indicator-grid">
                    <div class="indicator-card">
                        <h4>S&P 500</h4>
                        <div class="card-value" id="sp500">--</div>
                        <div class="card-subtitle" id="sp500Change">--</div>
                    </div>
                    <div class="indicator-card">
                        <h4>NASDAQ</h4>
                        <div class="card-value" id="nasdaq">--</div>
                        <div class="card-subtitle" id="nasdaqChange">--</div>
                    </div>
                    <div class="indicator-card">
                        <h4>Dow Jones</h4>
                        <div class="card-value" id="dow">--</div>
                        <div class="card-subtitle" id="dowChange">--</div>
                    </div>
                    <div class="indicator-card">
                        <h4>Nikkei 225</h4>
                        <div class="card-value" id="nikkei">--</div>
                        <div class="card-subtitle" id="nikkeiChange">--</div>
                    </div>
                    <div class="indicator-card">
                        <h4>Hang Seng</h4>
                        <div class="card-value" id="hangseng">--</div>
                        <div class="card-subtitle" id="hangsengChange">--</div>
                    </div>
                    <div class="indicator-card">
                        <h4>FTSE 100</h4>
                        <div class="card-value" id="ftse">--</div>
                        <div class="card-subtitle" id="ftseChange">--</div>
                    </div>
                </div>

                <h3 style="margin-top: 30px;">Intermarket Data</h3>
                <div class="indicator-grid">
                    <div class="indicator-card">
                        <h4>Crude Oil</h4>
                        <div class="card-value" id="crude">--</div>
                        <div class="card-subtitle">USD/Barrel</div>
                    </div>
                    <div class="indicator-card">
                        <h4>Gold</h4>
                        <div class="card-value" id="gold">--</div>
                        <div class="card-subtitle">USD/Oz</div>
                    </div>
                    <div class="indicator-card">
                        <h4>USD Index</h4>
                        <div class="card-value" id="usdIndex">--</div>
                        <div class="card-subtitle">DXY</div>
                    </div>
                    <div class="indicator-card">
                        <h4>USD/INR</h4>
                        <div class="card-value" id="usdInr">--</div>
                        <div class="card-subtitle">Currency</div>
                    </div>
                </div>

                <h3 style="margin-top: 30px;">Sector Indices</h3>
                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Sector</th>
                                <th>Current</th>
                                <th>Change</th>
                                <th>Change %</th>
                                <th>Trend</th>
                            </tr>
                        </thead>
                        <tbody id="sectorIndicesBody">
                            <tr><td colspan="5" style="text-align: center; padding: 20px;">Loading sector data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TAB 9: STOCK SCREENER -->
            <div class="tab-content" id="screener">
                <h2>üîç NSE Stock Screener</h2>

                <div class="screener-filters">
                    <div class="filter-group">
                        <label>Min Price</label>
                        <input type="number" class="config-input" id="minPrice" placeholder="0" style="width: 100px;">
                    </div>
                    <div class="filter-group">
                        <label>Max Price</label>
                        <input type="number" class="config-input" id="maxPrice" placeholder="10000" style="width: 100px;">
                    </div>
                    <div class="filter-group">
                        <label>Min Volume</label>
                        <input type="number" class="config-input" id="minVolume" placeholder="100000" style="width: 120px;">
                    </div>
                    <div class="filter-group">
                        <label>RSI Range</label>
                        <select class="config-input" id="rsiFilter" style="width: 150px;">
                            <option value="all">All</option>
                            <option value="oversold">Oversold (&lt;30)</option>
                            <option value="overbought">Overbought (&gt;70)</option>
                            <option value="neutral">Neutral (30-70)</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Trend</label>
                        <select class="config-input" id="trendFilter" style="width: 120px;">
                            <option value="all">All</option>
                            <option value="uptrend">Uptrend</option>
                            <option value="downtrend">Downtrend</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" id="applyFiltersBtn" style="align-self: flex-end;">Apply Filters</button>
                </div>

                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>LTP</th>
                                <th>Change %</th>
                                <th>Volume</th>
                                <th>RSI</th>
                                <th>MACD</th>
                                <th>Signal</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="screenerTableBody">
                            <tr><td colspan="8" style="text-align: center; padding: 40px;">Apply filters to screen stocks</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- System Logs (Always visible at bottom) -->
            <h3 style="margin-top: 40px;">üìù System Logs</h3>
            <div class="log-container" id="logContainer">
                <div class="log-entry">
                    <span class="log-timestamp">[--:--:--]</span>
                    <span class="log-info">Application initialized. Ready to connect.</span>
                </div>
            </div>

            <!-- Footer -->
            <footer class="footer">
                <p>Last Updated: <span id="footerTime">--</span> IST | Auto-refresh: <span id="footerRefresh">30</span>s | Data Age: <span id="dataAge">--</span>s</p>
                <p>üéØ NIFTY/SENSEX Trading Dashboard - Complete Edition | All features from app.py converted to HTML</p>
            </footer>
        </main>
    </div>

    <script>
        // ========================================================================
        // COMPLETE APPLICATION JAVASCRIPT
        // All features from app.py implemented in vanilla JavaScript
        // ========================================================================

        // Global State Management
        const AppState = {
            connected: false,
            websocket: null,
            autoRefreshTimer: null,
            credentials: {
                accessToken: '',
                clientId: '',
                telegramToken: '',
                telegramChatId: ''
            },
            marketData: {
                nifty: { price: 0, change: 0, changePercent: 0, atmStrike: 0, high: 0, low: 0, volume: 0 },
                sensex: { price: 0, change: 0, changePercent: 0, atmStrike: 0, high: 0, low: 0, volume: 0 },
                vix: { price: 0, change: 0 },
                priceHistory: [],
                timestamps: []
            },
            signals: {
                active: [],
                setups: [],
                positions: []
            },
            charts: {},
            currentTab: 'sentiment',
            currentSubTab: {}
        };

        // ========================================================================
        // INITIALIZATION
        // ========================================================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing NIFTY/SENSEX Trading Dashboard...');

            initializeApp();
            setupEventListeners();
            initializeCharts();
            updateClock();

            setInterval(updateClock, 1000);
            setInterval(updateMarketStatus, 60000); // Update market status every minute

            logMessage('‚úÖ Application initialized successfully', 'success');
            logMessage('üì° Ready to connect to DhanHQ WebSocket', 'info');
        });

        function initializeApp() {
            updateMarketStatus();
            loadCredentials();
            loadSavedSettings();

            const refreshInterval = document.getElementById('refreshInterval').value;
            document.getElementById('footerRefresh').textContent = refreshInterval;
        }

        // ========================================================================
        // EVENT LISTENERS
        // ========================================================================
        function setupEventListeners() {
            // Connection controls
            document.getElementById('connectBtn').addEventListener('click', connectWebSocket);
            document.getElementById('disconnectBtn').addEventListener('click', disconnectWebSocket);

            // Main tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });

            // Sub tabs
            document.querySelectorAll('.sub-tab').forEach(subtab => {
                subtab.addEventListener('click', function() {
                    switchSubTab(this.dataset.subtab);
                });
            });

            // Auto-refresh toggle
            document.getElementById('autoRefreshToggle').addEventListener('change', function(e) {
                if (e.target.checked) {
                    startAutoRefresh();
                } else {
                    stopAutoRefresh();
                }
            });

            // Quick actions
            document.getElementById('fetchDataBtn').addEventListener('click', fetchMarketData);
            document.getElementById('refreshChartsBtn').addEventListener('click', refreshAllCharts);
            document.getElementById('clearLogsBtn').addEventListener('click', clearLogs);
            document.getElementById('testTelegramBtn').addEventListener('click', testTelegramAlert);

            // Trade setup
            document.getElementById('createSetupBtn').addEventListener('click', createSignalSetup);

            // Screener filters
            document.getElementById('applyFiltersBtn').addEventListener('click', applyScreenerFilters);

            // Chart controls
            document.getElementById('chartTimeframe').addEventListener('change', updateChartTimeframe);
            document.getElementById('addSuperTrendBtn').addEventListener('click', () => addIndicatorToChart('supertrend'));
            document.getElementById('addEMABtn').addEventListener('click', () => addIndicatorToChart('ema'));
            document.getElementById('addVWAPBtn').addEventListener('click', () => addIndicatorToChart('vwap'));
        }

        // ========================================================================
        // TAB MANAGEMENT
        // ========================================================================
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                }
            });

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');

            AppState.currentTab = tabName;
            logMessage(`Switched to ${tabName} tab`, 'info');

            // Load tab-specific data
            loadTabData(tabName);
        }

        function switchSubTab(subtabName) {
            const parentTab = AppState.currentTab;

            // Update subtab buttons
            document.querySelectorAll('.sub-tab').forEach(subtab => {
                subtab.classList.remove('active');
                if (subtab.dataset.subtab === subtabName) {
                    subtab.classList.add('active');
                }
            });

            // Update subtab content
            document.querySelectorAll('.sub-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(subtabName).classList.add('active');

            AppState.currentSubTab[parentTab] = subtabName;
            logMessage(`Switched to ${subtabName} subtab`, 'info');
        }

        function loadTabData(tabName) {
            switch(tabName) {
                case 'sentiment':
                    updateSentimentAnalysis();
                    break;
                case 'setup':
                    updateSetupLevels();
                    break;
                case 'signals':
                    displayActiveSignals();
                    break;
                case 'positions':
                    updatePositions();
                    break;
                case 'bias':
                    runBiasAnalysis();
                    break;
                case 'charts':
                    updateChartData();
                    break;
                case 'options':
                    fetchOptionsChain();
                    break;
                case 'enhanced':
                    fetchEnhancedData();
                    break;
                case 'screener':
                    // Screener loads on filter apply
                    break;
            }
        }

        // ========================================================================
        // WEBSOCKET CONNECTION
        // ========================================================================
        function connectWebSocket() {
            const accessToken = document.getElementById('accessToken').value.trim();
            const clientId = document.getElementById('clientId').value.trim();

            if (!accessToken || !clientId) {
                alert('Please enter both Access Token and Client ID');
                logMessage('‚ùå Connection failed: Missing credentials', 'error');
                return;
            }

            AppState.credentials.accessToken = accessToken;
            AppState.credentials.clientId = clientId;
            saveCredentials();

            const wsUrl = `wss://api-feed.dhan.co?version=2&token=${accessToken}&clientId=${clientId}&authType=2`;

            try {
                updateConnectionStatus('connecting');
                logMessage('üì° Connecting to DhanHQ WebSocket...', 'info');

                AppState.websocket = new WebSocket(wsUrl);

                AppState.websocket.onopen = function() {
                    AppState.connected = true;
                    updateConnectionStatus('connected');
                    logMessage('‚úÖ WebSocket connected successfully', 'success');

                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('disconnectBtn').disabled = false;

                    // Subscribe to market data
                    subscribeToMarketData();

                    // Start auto-refresh if enabled
                    if (document.getElementById('autoRefreshToggle').checked) {
                        startAutoRefresh();
                    }
                };

                AppState.websocket.onmessage = function(event) {
                    handleWebSocketMessage(event);
                };

                AppState.websocket.onclose = function(event) {
                    AppState.connected = false;
                    updateConnectionStatus('disconnected');
                    logMessage(`‚ö†Ô∏è WebSocket closed: ${event.reason || 'Unknown reason'}`, 'warning');

                    document.getElementById('connectBtn').disabled = false;
                    document.getElementById('disconnectBtn').disabled = true;

                    stopAutoRefresh();
                };

                AppState.websocket.onerror = function(error) {
                    logMessage(`‚ùå WebSocket error: ${error.message || 'Unknown error'}`, 'error');
                };

            } catch (error) {
                updateConnectionStatus('disconnected');
                logMessage(`‚ùå Connection error: ${error.message}`, 'error');
            }
        }

        function disconnectWebSocket() {
            if (AppState.websocket && AppState.websocket.readyState === WebSocket.OPEN) {
                AppState.websocket.close();
                logMessage('üì¥ WebSocket disconnected by user', 'info');
            }
            updateConnectionStatus('disconnected');
            stopAutoRefresh();
        }

        function subscribeToMarketData() {
            const subscribeMessage = {
                RequestCode: 15,
                InstrumentCount: 3,
                InstrumentList: [
                    { ExchangeSegment: "NSE_INDEX", SecurityId: "13" },   // NIFTY 50
                    { ExchangeSegment: "BSE_INDEX", SecurityId: "1" },    // SENSEX
                    { ExchangeSegment: "NSE_INDEX", SecurityId: "69" }    // India VIX
                ]
            };

            if (AppState.websocket && AppState.websocket.readyState === WebSocket.OPEN) {
                AppState.websocket.send(JSON.stringify(subscribeMessage));
                logMessage('‚úÖ Subscribed to NIFTY, SENSEX, and India VIX', 'success');
            }
        }

        function handleWebSocketMessage(event) {
            if (event.data instanceof ArrayBuffer) {
                processBinaryData(event.data);
            } else {
                try {
                    const data = JSON.parse(event.data);
                    logMessage(`üì• Received: ${JSON.stringify(data).substring(0, 100)}...`, 'info');
                } catch (e) {
                    logMessage(`üì• Received text: ${event.data}`, 'info');
                }
            }
        }

        function processBinaryData(arrayBuffer) {
            try {
                const dataView = new DataView(arrayBuffer);
                const feedResponseCode = dataView.getUint8(0);
                const securityId = dataView.getUint32(4, true);

                if (feedResponseCode === 2 || feedResponseCode === 4) {
                    const ltp = dataView.getFloat32(8, true);
                    updateMarketPrice(securityId, ltp);
                }
            } catch (error) {
                logMessage(`‚ùå Error processing binary data: ${error.message}`, 'error');
            }
        }

        function updateMarketPrice(securityId, price) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-IN', { timeZone: 'Asia/Kolkata', hour12: false });

            // Update based on security ID
            if (securityId === 13) { // NIFTY 50
                AppState.marketData.nifty.price = price;
                AppState.marketData.nifty.atmStrike = Math.round(price / 50) * 50;
                updateNiftyUI(price);
            } else if (securityId === 1) { // SENSEX
                AppState.marketData.sensex.price = price;
                AppState.marketData.sensex.atmStrike = Math.round(price / 100) * 100;
                updateSensexUI(price);
            } else if (securityId === 69) { // India VIX
                AppState.marketData.vix.price = price;
                updateVixUI(price);
            }

            // Add to price history
            AppState.marketData.priceHistory.push(price);
            AppState.marketData.timestamps.push(timeStr);

            // Keep only last 200 points
            if (AppState.marketData.priceHistory.length > 200) {
                AppState.marketData.priceHistory.shift();
                AppState.marketData.timestamps.shift();
            }

            // Update charts
            updateCharts();

            // Update data age
            document.getElementById('dataAge').textContent = '0';
        }

        // UI Update Functions
        function updateNiftyUI(price) {
            document.getElementById('niftyPrice').textContent = `‚Çπ${price.toFixed(2)}`;
            document.getElementById('niftyATM').textContent = `ATM: ${AppState.marketData.nifty.atmStrike}`;
        }

        function updateSensexUI(price) {
            document.getElementById('sensexPrice').textContent = `‚Çπ${price.toFixed(2)}`;
            document.getElementById('sensexATM').textContent = `ATM: ${AppState.marketData.sensex.atmStrike}`;
        }

        function updateVixUI(price) {
            document.getElementById('vixPrice').textContent = price.toFixed(2);
        }

        // ========================================================================
        // SENTIMENT ANALYSIS
        // ========================================================================
        function updateSentimentAnalysis() {
            // Calculate overall sentiment from various indicators
            let sentimentScore = 0;
            let components = 0;

            // This would aggregate from:
            // - HTF S/R signals
            // - VOB signals
            // - Option chain bias
            // - Technical indicators
            // - Volume profile
            // - Proximity alerts

            // For demonstration, using random values
            const htfScore = (Math.random() - 0.5) * 100;
            const vobScore = (Math.random() - 0.5) * 100;
            const optionScore = (Math.random() - 0.5) * 100;
            const technicalScore = (Math.random() - 0.5) * 100;

            document.getElementById('htfSentiment').textContent = htfScore.toFixed(1);
            document.getElementById('vobSentiment').textContent = vobScore.toFixed(1);
            document.getElementById('optionBias').textContent = optionScore.toFixed(1);
            document.getElementById('technicalScore').textContent = technicalScore.toFixed(1);

            sentimentScore = (htfScore + vobScore + optionScore + technicalScore) / 4;

            // Update sentiment meter
            const sentimentPercent = ((sentimentScore + 100) / 200) * 100; // Convert -100 to +100 => 0 to 100%
            document.getElementById('sentimentPointer').style.left = sentimentPercent + '%';

            // Update overall sentiment display
            let sentimentText = 'NEUTRAL';
            let sentimentClass = 'value-neutral';

            if (sentimentScore > 30) {
                sentimentText = 'BULLISH';
                sentimentClass = 'value-positive';
            } else if (sentimentScore < -30) {
                sentimentText = 'BEARISH';
                sentimentClass = 'value-negative';
            }

            const sentimentEl = document.getElementById('overallSentiment');
            sentimentEl.textContent = sentimentText;
            sentimentEl.className = 'card-value ' + sentimentClass;

            document.getElementById('sentimentScore').textContent = 'Score: ' + sentimentScore.toFixed(1);
        }

        // ========================================================================
        // TRADE SETUP MANAGEMENT
        // ========================================================================
        function updateSetupLevels() {
            // Calculate nearest VOB levels
            const currentPrice = AppState.marketData.nifty.price;

            // Simulated VOB levels (would come from actual VOB analysis)
            const support = Math.floor(currentPrice / 50) * 50 - 50;
            const resistance = Math.ceil(currentPrice / 50) * 50 + 50;

            document.getElementById('currentPrice').textContent = `‚Çπ${currentPrice.toFixed(2)}`;
            document.getElementById('nearestSupport').textContent = `‚Çπ${support}`;
            document.getElementById('nearestResistance').textContent = `‚Çπ${resistance}`;

            // Pre-fill setup form
            document.getElementById('vobSupport').value = support;
            document.getElementById('vobResistance').value = resistance;
        }

        function createSignalSetup() {
            const index = document.getElementById('setupIndex').value;
            const direction = document.getElementById('setupDirection').value;
            const support = parseFloat(document.getElementById('vobSupport').value);
            const resistance = parseFloat(document.getElementById('vobResistance').value);

            if (!support || !resistance) {
                alert('Please enter both Support and Resistance levels');
                return;
            }

            const setup = {
                id: 'setup_' + Date.now(),
                index: index,
                direction: direction,
                vobSupport: support,
                vobResistance: resistance,
                signalCount: 0,
                status: 'pending',
                createdAt: new Date()
            };

            AppState.signals.setups.push(setup);

            logMessage(`‚úÖ Signal setup created for ${index} ${direction}`, 'success');
            alert(`‚úÖ Signal setup created!\n\nIndex: ${index}\nDirection: ${direction}\nSupport: ${support}\nResistance: ${resistance}\n\nGo to Active Signals tab to add confirmations.`);

            // Switch to signals tab
            switchTab('signals');
        }

        function displayActiveSignals() {
            const container = document.getElementById('activeSignalsList');

            if (AppState.signals.setups.length === 0) {
                container.innerHTML = `
                    <div class="info-box info">
                        <span>‚ÑπÔ∏è</span>
                        <div>No active signal setups. Create one in the Trade Setup tab.</div>
                    </div>
                `;
                return;
            }

            let html = '';

            AppState.signals.setups.forEach(setup => {
                const stars = '‚≠ê'.repeat(setup.signalCount) + '‚òÜ'.repeat(3 - setup.signalCount);
                const readyClass = setup.signalCount >= 3 ? 'success' : 'info';

                html += `
                    <div class="signal-setup-card">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h3>${setup.index} ${setup.direction}</h3>
                            <div class="signal-star">${stars} (${setup.signalCount}/3)</div>
                        </div>

                        <div style="margin: 15px 0;">
                            <p><strong>Support:</strong> ‚Çπ${setup.vobSupport}</p>
                            <p><strong>Resistance:</strong> ‚Çπ${setup.vobResistance}</p>
                            <p><strong>Status:</strong> <span class="${readyClass}">${setup.status}</span></p>
                        </div>

                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="addSignal('${setup.id}')"${setup.signalCount >= 3 ? ' disabled' : ''}>‚ûï Add Signal</button>
                            <button class="btn btn-danger" onclick="removeSignal('${setup.id}')"${setup.signalCount === 0 ? ' disabled' : ''}>‚ûñ Remove Signal</button>
                            <button class="btn btn-success" onclick="executeSetup('${setup.id}')"${setup.signalCount < 3 ? ' disabled' : ''}>üöÄ Execute Trade</button>
                            <button class="btn btn-danger" onclick="deleteSetup('${setup.id}')">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function addSignal(setupId) {
            const setup = AppState.signals.setups.find(s => s.id === setupId);
            if (setup && setup.signalCount < 3) {
                setup.signalCount++;
                if (setup.signalCount >= 3) {
                    setup.status = 'ready';
                    logMessage(`‚úÖ Setup ${setup.index} ${setup.direction} is READY to execute!`, 'success');
                    sendTelegramAlert(`üéØ Signal Ready!\n\n${setup.index} ${setup.direction}\nSupport: ${setup.vobSupport}\nResistance: ${setup.vobResistance}`);
                }
                displayActiveSignals();
            }
        }

        function removeSignal(setupId) {
            const setup = AppState.signals.setups.find(s => s.id === setupId);
            if (setup && setup.signalCount > 0) {
                setup.signalCount--;
                setup.status = 'pending';
                displayActiveSignals();
            }
        }

        function executeSetup(setupId) {
            const setup = AppState.signals.setups.find(s => s.id === setupId);
            if (!setup || setup.signalCount < 3) {
                alert('Need 3 confirmations before executing trade');
                return;
            }

            // Execute trade logic here
            const position = {
                id: 'pos_' + Date.now(),
                setupId: setupId,
                index: setup.index,
                direction: setup.direction,
                entry: setup.direction === 'CALL' ? setup.vobSupport : setup.vobResistance,
                sl: setup.direction === 'CALL' ? setup.vobSupport - 8 : setup.vobResistance + 8,
                target: setup.direction === 'CALL' ? setup.vobResistance : setup.vobSupport,
                quantity: 75, // NIFTY lot size
                status: 'active',
                entryTime: new Date(),
                pnl: 0
            };

            AppState.signals.positions.push(position);

            logMessage(`üöÄ Trade executed: ${setup.index} ${setup.direction} @ ${position.entry}`, 'success');
            alert(`‚úÖ Trade Executed!\n\nEntry: ${position.entry}\nSL: ${position.sl}\nTarget: ${position.target}\nQty: ${position.quantity}`);

            sendTelegramAlert(`üöÄ Trade Executed!\n\n${setup.index} ${setup.direction}\nEntry: ${position.entry}\nSL: ${position.sl}\nTarget: ${position.target}`);

            // Switch to positions tab
            switchTab('positions');
        }

        function deleteSetup(setupId) {
            if (confirm('Are you sure you want to delete this setup?')) {
                AppState.signals.setups = AppState.signals.setups.filter(s => s.id !== setupId);
                displayActiveSignals();
                logMessage('üóëÔ∏è Signal setup deleted', 'info');
            }
        }

        // ========================================================================
        // POSITION MONITORING
        // ========================================================================
        function updatePositions() {
            const openPositions = AppState.signals.positions.filter(p => p.status === 'active');
            const closedPositions = AppState.signals.positions.filter(p => p.status === 'closed');

            // Update stats
            document.getElementById('totalPositions').textContent = openPositions.length;

            const totalPnL = closedPositions.reduce((sum, p) => sum + p.pnl, 0);
            document.getElementById('todayPnL').textContent = `‚Çπ${totalPnL.toFixed(2)}`;
            document.getElementById('todayPnL').className = 'stat-value ' + (totalPnL >= 0 ? 'pnl-positive' : 'pnl-negative');

            const winningTrades = closedPositions.filter(p => p.pnl > 0).length;
            const winRate = closedPositions.length > 0 ? (winningTrades / closedPositions.length * 100).toFixed(1) : 0;
            document.getElementById('winRate').textContent = winRate + '%';

            // Display open positions
            const openContainer = document.getElementById('openPositionsList');
            if (openPositions.length === 0) {
                openContainer.innerHTML = `
                    <div class="info-box info">
                        <span>‚ÑπÔ∏è</span>
                        <div>No open positions. Execute a trade from Active Signals tab.</div>
                    </div>
                `;
            } else {
                let html = '';
                openPositions.forEach(pos => {
                    const currentPrice = AppState.marketData[pos.index.toLowerCase()].price;
                    const pnl = pos.direction === 'CALL' ? (currentPrice - pos.entry) * pos.quantity : (pos.entry - currentPrice) * pos.quantity;

                    html += `
                        <div class="position-card ${pnl < 0 ? 'loss' : ''}">
                            <div style="display: flex; justify-content: space-between;">
                                <h4>${pos.index} ${pos.direction}</h4>
                                <span class="${pnl >= 0 ? 'pnl-positive' : 'pnl-negative'}">‚Çπ${pnl.toFixed(2)}</span>
                            </div>
                            <div style="margin: 10px 0;">
                                <p>Entry: ‚Çπ${pos.entry} | SL: ‚Çπ${pos.sl} | Target: ‚Çπ${pos.target}</p>
                                <p>Current: ‚Çπ${currentPrice.toFixed(2)} | Qty: ${pos.quantity}</p>
                            </div>
                            <button class="btn btn-danger" onclick="closePosition('${pos.id}')">Close Position</button>
                        </div>
                    `;
                });
                openContainer.innerHTML = html;
            }
        }

        function closePosition(posId) {
            if (!confirm('Are you sure you want to close this position?')) return;

            const pos = AppState.signals.positions.find(p => p.id === posId);
            if (pos) {
                const currentPrice = AppState.marketData[pos.index.toLowerCase()].price;
                pos.pnl = pos.direction === 'CALL' ? (currentPrice - pos.entry) * pos.quantity : (pos.entry - currentPrice) * pos.quantity;
                pos.status = 'closed';
                pos.exitTime = new Date();
                pos.exitPrice = currentPrice;

                logMessage(`üìä Position closed: ${pos.index} ${pos.direction} | PnL: ‚Çπ${pos.pnl.toFixed(2)}`, pos.pnl >= 0 ? 'success' : 'error');
                sendTelegramAlert(`üìä Position Closed\n\n${pos.index} ${pos.direction}\nPnL: ‚Çπ${pos.pnl.toFixed(2)}`);

                updatePositions();
            }
        }

        // ========================================================================
        // CHARTING
        // ========================================================================
        function initializeCharts() {
            // Initialize Chart.js charts
            const ctx = document.getElementById('indicatorChart');
            if (ctx) {
                AppState.charts.indicator = new Chart(ctx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'RSI',
                                data: [],
                                borderColor: '#9c27b0',
                                yAxisID: 'y1'
                            },
                            {
                                label: 'MACD',
                                data: [],
                                borderColor: '#ff9800',
                                yAxisID: 'y2'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y1: {
                                type: 'linear',
                                position: 'left',
                                grid: { color: '#2a2e39' },
                                ticks: { color: '#787b86' }
                            },
                            y2: {
                                type: 'linear',
                                position: 'right',
                                grid: { display: false },
                                ticks: { color: '#787b86' }
                            },
                            x: {
                                grid: { color: '#2a2e39' },
                                ticks: { color: '#787b86' }
                            }
                        }
                    }
                });
            }

            // Initialize Plotly charts
            initializePlotlyCharts();
        }

        function initializePlotlyCharts() {
            // Candlestick chart
            const candlestickLayout = {
                dragmode: 'zoom',
                showlegend: false,
                xaxis: {
                    rangeslider: { visible: false },
                    gridcolor: '#2a2e39',
                    color: '#787b86'
                },
                yaxis: {
                    gridcolor: '#2a2e39',
                    color: '#787b86'
                },
                paper_bgcolor: '#131722',
                plot_bgcolor: '#131722',
                font: { color: '#ffffff' }
            };

            Plotly.newPlot('mainCandlestickChart', [], candlestickLayout, { responsive: true });
            Plotly.newPlot('biasChart', [], candlestickLayout, { responsive: true });
        }

        function updateCharts() {
            // Update charts with latest data
            if (AppState.marketData.priceHistory.length === 0) return;

            // Update indicator chart
            if (AppState.charts.indicator) {
                const rsiData = calculateRSI(AppState.marketData.priceHistory, 14);
                const macdData = calculateMACD(AppState.marketData.priceHistory);

                AppState.charts.indicator.data.labels = AppState.marketData.timestamps;
                AppState.charts.indicator.data.datasets[0].data = rsiData;
                AppState.charts.indicator.data.datasets[1].data = macdData.histogram;
                AppState.charts.indicator.update('none');

                // Update RSI display
                if (rsiData.length > 0) {
                    const currentRSI = rsiData[rsiData.length - 1];
                    document.getElementById('chartRSI').textContent = currentRSI.toFixed(2);
                    document.getElementById('chartRSIProgress').style.width = currentRSI + '%';
                }
            }
        }

        function refreshAllCharts() {
            logMessage('üîÑ Refreshing all charts...', 'info');
            updateCharts();
            updateChartData();
        }

        function updateChartData() {
            // Fetch and update chart data based on current timeframe
            // This would typically call an API to get historical data
            logMessage('üìä Updating chart data...', 'info');
        }

        function updateChartTimeframe() {
            const timeframe = document.getElementById('chartTimeframe').value;
            logMessage(`üìä Changing timeframe to ${timeframe}`, 'info');
            updateChartData();
        }

        function addIndicatorToChart(indicator) {
            logMessage(`‚ûï Adding ${indicator} to chart`, 'info');
            // Implementation would add the indicator overlay
        }

        // ========================================================================
        // TECHNICAL INDICATORS
        // ========================================================================
        function calculateRSI(prices, period = 14) {
            const rsi = [];
            const gains = [];
            const losses = [];

            for (let i = 1; i < prices.length; i++) {
                const change = prices[i] - prices[i - 1];
                gains.push(change > 0 ? change : 0);
                losses.push(change < 0 ? -change : 0);
            }

            if (gains.length < period) return rsi;

            let avgGain = gains.slice(0, period).reduce((a, b) => a + b, 0) / period;
            let avgLoss = losses.slice(0, period).reduce((a, b) => a + b, 0) / period;

            for (let i = period; i < prices.length; i++) {
                const rs = avgGain / avgLoss;
                rsi.push(100 - (100 / (1 + rs)));

                avgGain = ((avgGain * (period - 1)) + gains[i]) / period;
                avgLoss = ((avgLoss * (period - 1)) + losses[i]) / period;
            }

            return rsi;
        }

        function calculateMACD(prices, fastPeriod = 12, slowPeriod = 26, signalPeriod = 9) {
            const emaFast = calculateEMA(prices, fastPeriod);
            const emaSlow = calculateEMA(prices, slowPeriod);

            const macdLine = [];
            for (let i = 0; i < emaFast.length; i++) {
                macdLine.push(emaFast[i] - emaSlow[i]);
            }

            const signalLine = calculateEMA(macdLine, signalPeriod);
            const histogram = [];

            for (let i = 0; i < macdLine.length; i++) {
                histogram.push(macdLine[i] - (signalLine[i] || 0));
            }

            return { macdLine, signalLine, histogram };
        }

        function calculateEMA(prices, period) {
            const ema = [];
            const multiplier = 2 / (period + 1);

            ema[0] = prices[0];

            for (let i = 1; i < prices.length; i++) {
                ema[i] = (prices[i] - ema[i - 1]) * multiplier + ema[i - 1];
            }

            return ema;
        }

        // ========================================================================
        // DATA FETCHING
        // ========================================================================
        function fetchMarketData() {
            if (!AppState.connected) {
                logMessage('‚ö†Ô∏è Cannot fetch data: Not connected', 'warning');
                return;
            }

            logMessage('üì° Fetching latest market data...', 'info');

            // Simulate data fetch - in production, this would call APIs
            setTimeout(() => {
                logMessage('‚úÖ Market data updated', 'success');
                updateSentimentAnalysis();
            }, 500);
        }

        function runBiasAnalysis() {
            logMessage('üé≤ Running bias analysis...', 'info');
            // Implementation would calculate bias from multiple indicators
        }

        function fetchOptionsChain() {
            logMessage('‚ö° Fetching options chain data...', 'info');
            // Implementation would fetch from API
        }

        function fetchEnhancedData() {
            logMessage('üåê Fetching enhanced market data...', 'info');
            // Implementation would fetch global markets, sectors, etc.
        }

        function applyScreenerFilters() {
            logMessage('üîç Applying screener filters...', 'info');
            // Implementation would filter stocks based on criteria
        }

        // ========================================================================
        // TELEGRAM ALERTS
        // ========================================================================
        function testTelegramAlert() {
            const token = document.getElementById('telegramToken').value;
            const chatId = document.getElementById('telegramChatId').value;

            if (!token || !chatId) {
                alert('Please enter both Telegram Bot Token and Chat ID');
                return;
            }

            AppState.credentials.telegramToken = token;
            AppState.credentials.telegramChatId = chatId;
            saveCredentials();

            sendTelegramAlert('üéØ Test Alert from NIFTY/SENSEX Trading Dashboard\n\nTelegram integration is working!');
        }

        function sendTelegramAlert(message) {
            const token = AppState.credentials.telegramToken;
            const chatId = AppState.credentials.telegramChatId;

            if (!token || !chatId) return;

            const url = `https://api.telegram.org/bot${token}/sendMessage`;
            const data = {
                chat_id: chatId,
                text: message,
                parse_mode: 'HTML'
            };

            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    logMessage('‚úÖ Telegram alert sent', 'success');
                } else {
                    logMessage('‚ùå Failed to send Telegram alert', 'error');
                }
            })
            .catch(error => {
                logMessage(`‚ùå Telegram error: ${error.message}`, 'error');
            });
        }

        // ========================================================================
        // AUTO REFRESH
        // ========================================================================
        function startAutoRefresh() {
            const interval = parseInt(document.getElementById('refreshInterval').value) * 1000;

            stopAutoRefresh();

            AppState.autoRefreshTimer = setInterval(() => {
                if (AppState.connected) {
                    fetchMarketData();
                }
            }, interval);

            logMessage(`‚úÖ Auto-refresh enabled (${interval / 1000}s)`, 'success');
        }

        function stopAutoRefresh() {
            if (AppState.autoRefreshTimer) {
                clearInterval(AppState.autoRefreshTimer);
                AppState.autoRefreshTimer = null;
                logMessage('‚è∏Ô∏è Auto-refresh disabled', 'info');
            }
        }

        // ========================================================================
        // UI HELPERS
        // ========================================================================
        function updateConnectionStatus(status) {
            const dot = document.getElementById('connectionDot');
            const text = document.getElementById('connectionText');

            dot.classList.remove('status-connected', 'status-disconnected', 'status-connecting');

            switch (status) {
                case 'connected':
                    dot.classList.add('status-connected');
                    text.textContent = 'Connected';
                    break;
                case 'connecting':
                    dot.classList.add('status-connecting');
                    text.textContent = 'Connecting...';
                    break;
                case 'disconnected':
                    dot.classList.add('status-disconnected');
                    text.textContent = 'Disconnected';
                    break;
            }
        }

        function updateMarketStatus() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const day = now.getDay();

            const isWeekday = day >= 1 && day <= 5;
            const isMarketHours = (hours === 9 && minutes >= 15) || (hours > 9 && hours < 15) || (hours === 15 && minutes <= 30);

            const badge = document.getElementById('marketStatusBadge');
            if (isWeekday && isMarketHours) {
                badge.textContent = 'Market Open';
                badge.classList.remove('closed');
                badge.classList.add('open');
            } else {
                badge.textContent = 'Market Closed';
                badge.classList.remove('open');
                badge.classList.add('closed');
            }
        }

        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-IN', { timeZone: 'Asia/Kolkata', hour12: false });
            document.getElementById('currentTime').textContent = `${timeStr} IST`;
            document.getElementById('footerTime').textContent = timeStr;
        }

        // ========================================================================
        // LOGGING
        // ========================================================================
        function logMessage(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString('en-IN', { hour12: false });
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';

            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="log-${type}">${message}</span>
            `;

            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;

            while (logContainer.children.length > 100) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }

        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
            logMessage('üßπ Logs cleared', 'info');
        }

        // ========================================================================
        // LOCAL STORAGE
        // ========================================================================
        function saveCredentials() {
            try {
                localStorage.setItem('dhan_credentials', JSON.stringify(AppState.credentials));
            } catch (e) {
                console.error('Failed to save credentials', e);
            }
        }

        function loadCredentials() {
            try {
                const saved = localStorage.getItem('dhan_credentials');
                if (saved) {
                    const creds = JSON.parse(saved);
                    AppState.credentials = creds;

                    if (creds.accessToken) document.getElementById('accessToken').value = creds.accessToken;
                    if (creds.clientId) document.getElementById('clientId').value = creds.clientId;
                    if (creds.telegramToken) document.getElementById('telegramToken').value = creds.telegramToken;
                    if (creds.telegramChatId) document.getElementById('telegramChatId').value = creds.telegramChatId;
                }
            } catch (e) {
                console.error('Failed to load credentials', e);
            }
        }

        function loadSavedSettings() {
            try {
                const settings = localStorage.getItem('app_settings');
                if (settings) {
                    const s = JSON.parse(settings);
                    if (s.vobProximity) document.getElementById('vobProximity').value = s.vobProximity;
                    if (s.riskPercent) document.getElementById('riskPercent').value = s.riskPercent;
                    if (s.refreshInterval) document.getElementById('refreshInterval').value = s.refreshInterval;
                }
            } catch (e) {
                console.error('Failed to load settings', e);
            }
        }

        // ========================================================================
        // CLEANUP
        // ========================================================================
        window.addEventListener('beforeunload', function() {
            if (AppState.websocket && AppState.websocket.readyState === WebSocket.OPEN) {
                AppState.websocket.close();
            }
            stopAutoRefresh();
        });
    </script>
</body>
</html>
